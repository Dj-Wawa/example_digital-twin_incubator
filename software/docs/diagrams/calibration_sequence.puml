@startuml Calibration
boundary Client as client
control Calibrator as cal
entity Simulator as sim
database InfluxDB as db
client ->> cal: calibrate(start_date, end_date, simulator, n, record_params)
loop n times
  cal -> sim: run(start_date, end_date, params_i)
  sim -> db: get_cached_trajectories(start_date, end_date)
  return room_t_data
  note over sim
    This is a cached operation,
    to improve performance.
  end note
  sim -> sim: run_simulation(room_t_data, params_i)
  sim --> cal: results
  cal -> cal: residual := calc(results)
  cal -> cal: params_{i+1} := update(params_i, residual)
end
opt record_params
  cal ->> sim: record_params(params_i)
end
cal ->> client: params
@enduml